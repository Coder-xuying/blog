#### MVCC

**1、MVCC**

概念：

- 视图

- - View ：当前读视图，用于取最新的
  - consistent read view：一致性读视图  （MVCC中的视图，用于实现RR和RC）

- 事务ID（transaction id），每一个事务都有唯一id，分配给事务，字段名是row trx_id

- - 更新事务：分配实际的事务id，严格从0开始递增
  - 只读事务：事务id分配一个特别大的id（当前事务的trx_id+2^48），只用于读

- 数据库的一行记录，有多个版本，每个版本有自己的 row trx_id。

- - ![image-20240703230958677](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/image-20240703230958677.png)
  - 图中的三个虚线箭头，就是 undo log，上述v1、v2、v3视图不是真实存在的，而是通过当前版本和undo log计算得到的



一个事务启动的时候，能看到所有**已经提交**的事务结果，这个事务执行的期间，其他事务的更新对它不可见，所以这个事务会以自己启动的时候为准，根据事务id去找到对它可见的数据（undo log + trx_id计算）

> 事务启动的时候会对整个库做一个**快照**

如何做到的：

innodb为每个事务构造了一个数据，保存事务启动的时候，所有的正在**活跃**的事务id。活跃是指启动了还没有提交的事务





> Mysql 45讲一个比较特殊的点，视图数组，指的是当前系统的所有事务id构成的数组，而不是某个事务自己拥有的                           