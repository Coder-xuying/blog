## 系统设计

### 0.提升面试竞争力的几个认识

#### 1.对架构设计的认知

- 为什么做架构拆分。 =》 =〉 =》 技术上提效的一种手段
- 为什么做系统解耦
- 为什么要做职责单一
- 为什么要关注开发效率

#### 2.对分析问题的认知

- 业务方：关注点在系统能力
- 管理者：关注点在人效管理
- 技术人员：系统设计原则。立足于现阶段的主要矛盾



![image-20221015165724120](/Users/xuying/Library/Application Support/typora-user-images/image-20221015165724120.png)



#### 3.对能力边界的认知

- 关注点

![image-20221015165915617](/Users/xuying/Library/Application Support/typora-user-images/image-20221015165915617.png)





## 九章系统设计

### 1. 4S分析法

#### 1.了解

通常，面试官问的系统设计题都是很模糊的，比如让你设计一个推特？我们需要想面试官提问，来了解面试官想要我们回答的重点

4s分析：

- Scenairo 场景
  - 需要设计哪些功能，需要有多牛
  - QPS、DAU、Interface -- **ASK**
- Service：服务
  - 将大系统拆分为小系统
  - application/module   -- **Split**
- storage：存储（重要）
  - 数据如何存储和访问， 先知道怎么取，才知道选什么来存
  - SQL、NoSQL、file system
- scale ：升级
  - 解决缺陷，处理可能存在的问题
  - sharding、special case



#### 2.storage分析-推特例子

- 数据库系统
  - 关系型 sql
    - user info
  - 非关系型 nosql
    - 推文（tweets）
    - 社交图谱（好友）
- 文件系统
  - 图片、视频
- 缓存系统
  - 不支持持久化
  - 效率高

第一步：选择合适的存储系统

第二步：细化数据表结构

![image-20221026102101458](/Users/xuying/Library/Application Support/typora-user-images/image-20221026102101458.png)



##### 2.两种模式-- 新鲜事系统（News feed）

新鲜事：

- 登录facebook、朋友圈、推特看到的朋友的信息流（说说）
- 你的朋友发的所有信息的集合
- 典型的：Facebook，twitter，朋友圈
- 核心因素
  - 关注和被关注
  - 每个人看到的新鲜事都不一样

**这里的分析只针对人数不多，人数多了再往后升级那节**

###### pull 模型

**场景**：获取用户关注列表里时间靠前的100条数据（刷朋友圈，一般都会显示20条左右）

**算法**：用户查看的时候，首先获取每个好友的前100条数据，对这些数据使用排序算法，合并出前100条数据

**复杂度分析**：

- Get my new feed（刷新朋友圈）：假如有N个关注对象，N次DB Read的时间，并且还有排序的时间（N路归并算法之类的） --排序的时间可以忽略因为是在内存中操作，即**DB是主要耗时**
- post a tweet（发帖子）：一次DB就可以

**缺点**：用户发起请求之后才进行计算，速度慢

原理图：

![image-20221026111149146](/Users/xuying/Library/Application Support/typora-user-images/image-20221026111149146.png)

伪代码：

![image-20221026111254482](/Users/xuying/Library/Application Support/typora-user-images/image-20221026111254482.png)

###### push 模型

> 算法：

- 为每个用户建立一个list存储news feed
- 一个用户当发帖之后，将推文发送到关注他的每个用户的list种
- 用户查看的时候，只需要取出list种的前100条记录即可

> 复杂度分析：

- get News feed：1次DB read
- post a tweet：N个粉丝需要N次DB（可以异步执行）



> 具体怎么做？

需要一个表结构：

```MYSQL
Table NEW_FEEDS_TAB
ID iNTEGER
owner_id foreign key
tweet_id foreign key
create_time timestamp
```

存在一个NEW_FEEDS_TAB的表，里面存放所有的Feeds，比如我是小明，我的关注者有A，B，C三个用户，我发了个帖子（tweet_id = 100），那么表里面就有四条数据，B关注了C，C也发了一条帖子，数据库就有6条了

```
1 小明 100 xx时间
2 A   100 XX时间
3 B   100 XX时间
4 C   100 XX时间
```

然后，B去刷新朋友圈，直接走一次DB查询，select * from NEW_FEEDS_TAB where owner_id=B order by create_time desc就可以l

> **缺点**：

粉丝太多，比如几千万人，你随便发个帖子，要创建几千万的记录

> 伪代码

![image-20221026112441996](/Users/xuying/Library/Application Support/typora-user-images/image-20221026112441996.png)



###### 两种模式的权衡

两种方式都可以满足要求，但都存在问题

热门app的模型：

- Facebook：pull
- Instagram: pull+push
- tweet：pull
- 朋友圈：大概率是push

权衡：

- 不要两边摇摆，都有问题的
- 针对问题再慢慢解决

### 3.scale 分析