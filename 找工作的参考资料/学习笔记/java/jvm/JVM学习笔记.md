

## jvm

### 1.å†…å­˜ç»“æ„

#### 2.è™šæ‹Ÿæœºæ ˆ

>-Xss  åˆ†é…æ ˆçš„å¤§å°

```java
-Xss 1m 
```



  æ ˆå¤ªå¤§ï¼Œèƒ½åˆ›å»ºçš„çº¿ç¨‹å°±å°‘ï¼Œé™ä½æ•ˆç‡





é—®é¢˜è¾¨æ3ï¼š

è¿™ä¸‰ä¸ªå“ªäº›æ˜¯çº¿ç¨‹å®‰å…¨çš„ ã€‚m1 ä¸ç”¨è€ƒè™‘ï¼Œm2\m3éƒ½è¦è€ƒè™‘

![image-20211014191948861](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211014191948.png)

#### 4ã€å †

##### 4.1å®šä¹‰

Heap å †

- é€šè¿‡new å…³é”®å­—ï¼Œåˆ›å»ºå¯¹è±¡éƒ½ä¼šä½¿ç”¨å †å†…å­˜

ç‰¹ç‚¹

- çº¿ç¨‹å…±äº«ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜
- æœ‰åƒåœ¾å›æ”¶æœºåˆ¶

##### 4.2 å †å†…å­˜æº¢å‡º

OutOfMemory

> -Xmx

```
-Xmx8M
```

é€šè¿‡è¿™ä¸ªè®¾ç½®å †çš„å¤§å°ï¼Œè°ƒå°ä¸€äº›ï¼Œèƒ½æ›´å¿«å‘ç°å †å†…å­˜æº¢å‡ºçš„é—®é¢˜



##### 4.3 å †å†…å­˜è¯Šæ–­

1. jps å·¥å…·
æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­æœ‰å“ªäº› java è¿›ç¨‹
2. jmap å·¥å…·
æŸ¥çœ‹å †å†…å­˜å ç”¨æƒ…å†µ jmap - heap è¿›ç¨‹id
3. jconsole å·¥å…·
å›¾å½¢ç•Œé¢çš„ï¼Œå¤šåŠŸèƒ½çš„ç›‘æµ‹å·¥å…·ï¼Œå¯ä»¥è¿ç»­ç›‘æµ‹



```
jps æŸ¥çœ‹javaè¿›ç¨‹

jmap -heap è¿›ç¨‹ID  æŸ¥çœ‹å †ä¿¡æ¯
```



> æ¡ˆä¾‹

åƒåœ¾å›æ”¶åï¼Œå†…å­˜å ç”¨ä»ç„¶å¾ˆé«˜

jvisualvm  å¯è§†åŒ–è™šæ‹Ÿæœº



#### 5ã€æ–¹æ³•åŒº

##### 5.1 å®šä¹‰

![image-20211015195008078](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211015195008.png)

æ–¹æ³•åŒºæ˜¯è§„èŒƒï¼Œå…ƒç©ºé—´æˆ–è€…æ°¸ä¹…ä»£éƒ½æ˜¯å®ƒçš„ä¸€ç§å®ç°



##### 5.2 ç»„æˆ

![image-20211015195113270](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211015195113.png)

![image-20211015195119490](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211015195119.png)



##### 5.3 æ–¹æ³•åŒºå†…å­˜æº¢å‡º

> 1.8ç‰ˆæœ¬   -XX:MaxMetaspaceSize=8M  è®¾ç½®å…ƒç©ºé—´å¤§å°

![image-20211015195736878](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211015195736.png)



> 1.6çš„jdkï¼Œ-XX:MaxPermSize=8m  åŒæ ·çš„ä»£ç  

![image-20211015195815714](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211015195815.png)



##### 4.è¿è¡Œæ—¶å¸¸é‡æ± 

- å¸¸é‡æ± ï¼Œå°±æ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ç­‰ä¿¡æ¯
- è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¸¸é‡æ± æ˜¯ *.class æ–‡ä»¶ä¸­çš„ï¼Œå½“è¯¥ç±»è¢«åŠ è½½ï¼Œå®ƒçš„å¸¸é‡æ± ä¿¡æ¯å°±ä¼šæ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¹¶æŠŠé‡Œé¢çš„ç¬¦å·åœ°å€å˜ä¸ºçœŸå®åœ°å€



```java
javap -v HelloWorld.class #åç¼–è¯‘
```

![image-20211015201932291](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211015201932.png)

ä¸Šé¢æ˜¯åç¼–è¯‘ä¹‹åçš„ä»£ç ï¼Œå¸¸é‡æ± å°±æ˜¯constant poolï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå°±æ˜¯æŠŠä¸Šé¢çš„å†…å®¹æ”¾è¿›å†…å­˜é‡Œ



##### 5,5 StringTable

å­—ç¬¦ä¸²æ± 

```java
String s1 = "a";
String s2 = "b";
String s3 = "a" + "b";  // è¿™é‡Œæœ‰ç¼–è¯‘å™¨è‡ªå·±ä¼˜åŒ–çš„ï¼Œå¸¸é‡æ± ç›´æ¥åˆ›å»ºäº†abè¿™ä¸ªä¸œè¥¿ï¼Œç„¶åæ”¾å…¥ä¸²æ± 
String s4 = s1 + s2;  // è¿™ç›¸å½“äºåˆ›å»ºäº†StringBuilderï¼Œå–å‡ºs1ç„¶åappend("a")ï¼Œå–å‡ºs2,append("a"),ç„¶åtoString()è¿”å› toStringï¼Œæ˜¯new String("ab")çš„å¯¹è±¡
String s5 = "ab";// è¿™ä¸ªç­‰äºs5ï¼Œç›´æ¥å–å‡ºStringTableé‡Œçš„"ab"
String s6 = s4.intern();
```

- å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²ä»…æ˜¯ç¬¦å·ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°æ—¶æ‰å˜ä¸ºå¯¹è±¡
- åˆ©ç”¨ä¸²æ± çš„æœºåˆ¶ï¼Œæ¥é¿å…é‡å¤åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡
- å­—ç¬¦ä¸²å˜é‡æ‹¼æ¥çš„åŸç†æ˜¯ StringBuilder ï¼ˆ1.8ï¼‰
- å­—ç¬¦ä¸²å¸¸é‡æ‹¼æ¥çš„åŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–
- å¯ä»¥ä½¿ç”¨ intern æ–¹æ³•ï¼Œä¸»åŠ¨å°†ä¸²æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥ä¸²æ± 
  - 1.8 å°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ï¼Œ**å¦‚æœæœ‰åˆ™å¹¶ä¸ä¼šæ”¾å…¥**ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ”¾å…¥ä¸²æ± ï¼Œ ä¼šæŠŠä¸²æ± ä¸­çš„å¯¹è±¡è¿”å›
  - 1.6 å°†è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥ä¸²æ± ï¼Œ**å¦‚æœæœ‰åˆ™å¹¶ä¸ä¼šæ”¾å…¥**ï¼Œå¦‚æœæ²¡æœ‰ä¼šæŠŠæ­¤å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥ä¸²æ± ï¼Œ ä¼šæŠŠä¸²æ± ä¸­çš„å¯¹è±¡è¿”å›

![image-20211016123408719](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211016123408.png)

1.8çš„è¿‡ç¨‹ï¼š

å¦‚æœæ²¡æœ‰string x ="ab"è¿™ä¸€è¡Œï¼Œé‚£ä¹ˆå°±æ˜¯å…ˆè¿è¡Œåˆ°sï¼Œå‘ç°ä¸²æ± é‡Œé¢æ²¡æœ‰aå’Œbï¼Œå°±ä¸¢è¿›[a,b]ï¼Œç„¶åsåˆ›å»ºäº†ä¸€ä¸ªnew String("ab")å¯¹è±¡ï¼Œç„¶åè¿è¡Œåˆ°s2ï¼Œå°±æŠŠsçš„è¿™ä¸ª"ab"ä¸¢è¿›ä¸²æ± äº†ã€‚

ã€a,b,abã€‘.s2å°±æ˜¯ä¸²æ± é‡Œé¢çš„abï¼Œsä¹Ÿæ˜¯ã€‚æ‰€ä»¥ s2==s



å¦‚æœæŒ‰å›¾ä¸Šé¢æ‰€ç¤ºï¼šæ‰§è¡Œåˆ°xçš„æ—¶å€™ï¼Œä¼šæŠŠ"ab"ä¸¢å…¥ä¸²æ± ï¼Œã€abã€‘ï¼Œæ‰§è¡Œåˆ°sï¼Œå°±æœ‰ã€a,b,abã€‘s = new String("ab") ï¼Œç„¶åæ‰§è¡Œinternæ–¹æ³•ï¼Œå› ä¸º"ab"åœ¨ä¸²æ± é‡Œäº†ï¼Œæ‰€ä»¥så°±ä¸æ”¾è¿›å»ï¼Œs2å–å‡ºä¸²æ± é‡Œé¢çš„"ab"ï¼Œæ‰€ä»¥ æœ€åçš„ç»“æœæ˜¯trueï¼Œfalse



##### 5.6 StringTableçš„ä½ç½®

![image-20211016211317418](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211016211317.png)

##### 5.7 StringTable åƒåœ¾å›æ”¶

ä¹Ÿä¼šå‘ç”Ÿåƒåœ¾å›æ”¶

##### 5.8 StringTable æ€§èƒ½è°ƒä¼˜

è°ƒæ•´ -XX:StringTableSize=æ¡¶ä¸ªæ•°
è€ƒè™‘å°†å­—ç¬¦ä¸²å¯¹è±¡æ˜¯å¦å…¥æ± 



#### 6. ç›´æ¥å†…å­˜

##### 6.1å®šä¹‰

Direct Memory(æ€§èƒ½æ¯”è¾ƒé«˜)

- å¸¸è§äº NIO æ“ä½œæ—¶ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒº
- åˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜ï¼Œä½†è¯»å†™æ€§èƒ½é«˜
- ä¸å— JVM å†…å­˜å›æ”¶ç®¡ç† ï¼ˆè¿˜æ˜¯ä¼šå†…å­˜æº¢å‡ºï¼‰



> æ€§èƒ½å¯¹æ¯”

![image-20211023153308579](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023153308.png)





> ä¸ºä»€ä¹ˆç›´æ¥å†…å­˜æ¯”è¾ƒå¿«ï¼Ÿ

javaå¤åˆ¶æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åä»ç£ç›˜æ–‡ä»¶è¯»å–éƒ¨åˆ†æ•°æ®åˆ°ç³»ç»Ÿç¼“å­˜åŒºï¼Œç„¶åå†ä»ç³»ç»Ÿç¼“å­˜åŒºï¼Œå¤åˆ¶åˆ°javaç¼“å†²åŒºbyte[]ï¼Œç„¶åå†å¤åˆ¶åˆ°å¦ä¸€ä»½æ–‡ä»¶ä¸­ã€‚ç„¶ååå¤è¿™æ ·æ“ä½œã€‚

![image-20211023153457778](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023153457.png)





åŠ å…¥ç›´æ¥å†…å­˜ï¼Œjavaå’Œç³»ç»Ÿéƒ½èƒ½ç›´æ¥è®¿é—®ç›´æ¥å†…å­˜çš„æ•°æ®ï¼Œ**å°‘äº†ä¸€æ¬¡å¤åˆ¶çš„è¿‡ç¨‹**

![image-20211023153828874](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023153828.png)



> ç›´æ¥å†…å­˜æº¢å‡º

![image-20211023154043218](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023154043.png)







##### 6.2 åˆ†é…å’Œå›æ”¶åŸç†

è¿™ä¸ªä¸å—jvmç®¡ç†ï¼Œæ‰€ä»¥è¦æŸ¥çœ‹å˜åŒ–å¯ä»¥çœ‹ç³»ç»Ÿå†…å­˜çš„å ç”¨(**ä»»åŠ¡ç®¡ç†å™¨)**

system.gc() ä¼šå›æ”¶ç›´æ¥å†…å­˜

**ç›´æ¥å†…å­˜ ä¼šè¢«å›æ”¶æ‰**ï¼Œä½†æ˜¯ä¸æ˜¯è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„ï¼Œè€Œæ˜¯unsafeè¿™ä¸ªåº•å±‚ç±»æ“ä½œçš„ã€‚

> é‡Šæ”¾åŸç†

- ä½¿ç”¨äº† Unsafe å¯¹è±¡å®Œæˆç›´æ¥å†…å­˜çš„åˆ†é…å›æ”¶ï¼Œå¹¶ä¸”å›æ”¶éœ€è¦ä¸»åŠ¨è°ƒç”¨ freeMemory æ–¹æ³•
- ByteBuffer çš„å®ç°ç±»å†…éƒ¨ï¼Œä½¿ç”¨äº† Cleaner ï¼ˆè™šå¼•ç”¨ï¼‰æ¥ç›‘æµ‹ ByteBuffer å¯¹è±¡ï¼Œä¸€æ—¦ByteBuffer å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šç”± ReferenceHandler çº¿ç¨‹é€šè¿‡ Cleaner çš„ clean æ–¹æ³•è°ƒç”¨ freeMemory æ¥é‡Šæ”¾ç›´æ¥å†…å­˜

![image-20211023154610878](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023154610.png)





![image-20211023154918039](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023154918.png)

**è™šå¼•ç”¨**å¯¹è±¡cleanerï¼Œè¿™é‡Œçš„thisæ˜¯bytebufferå¯¹è±¡(å…³è”èµ·æ¥)ï¼Œåé¢çš„new xxx ç›¸å½“äºä¸¢ä¸ªäº†çº¿ç¨‹è¿›å»(é‡Œé¢æœ‰unsafeç±»çš„é‡Šæ”¾æ–¹æ³•)ã€‚ï¼Œå¦‚æœå®ƒå…³è”çš„å¯¹è±¡è¢«å›æ”¶ï¼Œå°±ä¼šcleanerä¼šè§¦å‘cleanæ–¹æ³•ï¼Œcleanæ–¹æ³•é‡Œé¢ä¼šæ‰§è¡Œè¿™ä¸ªä»»åŠ¡çº¿ç¨‹çš„runæ–¹æ³•ã€‚  (**referanceHandlerè§‚æµ‹è¿™äº›è™šå¼•ç”¨å¯¹è±¡**ï¼Œæ¥å®Œæˆä¸Šé¢çš„æ“ä½œ)

```java
public class Cleaner extends PhantomReference<Object> {}

cleaner = Cleaner.create(this, new Deallocator(base, size, cap));

// ä»»åŠ¡
private static class Deallocator implements Runnable{
    public void run() {
        if (address == 0) {
            // Paranoia
            return;
        }
        unsafe.freeMemory(address);
        address = 0;
        Bits.unreserveMemory(size, capacity);
    }
}
```





> -XX:+DisableExplicitGC ç¦ç”¨æ˜¾ç¤ºçš„gc

System.gc() å°±æ˜¯æ˜¾ç¤ºçš„åƒåœ¾å›æ”¶ï¼Œæ˜¯FULL GC ï¼Œæ•ˆç‡å¾ˆä½ 

ä¸Šé¢è¿™ä¸ªå‚æ•°å¯ä»¥è®©System.gc() æ²¡æœ‰ç”¨



ä½†æ˜¯ç¦ç”¨äº†è¿™ä¸ªï¼Œ**ç›´æ¥å†…å­˜å°±æ²¡æ³•è¢«æ˜¾ç¤ºå›æ”¶äº†**ï¼Œåªèƒ½çœŸæ­£çš„åƒåœ¾å›æ”¶æ—¶ï¼Œæ‰å›æ”¶å»ï¼Œä¼šè¾ƒé•¿æ—¶é—´çš„å ç”¨å†…å­˜ã€‚  **å¯ä»¥æ‰‹åŠ¨çš„ç”¨unsafeç±»é‡Šæ”¾å†…å­˜**

 



### 2.åƒåœ¾å›æ”¶

[1.å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶](#1.å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶)
[2.åƒåœ¾å›æ”¶ç®—æ³•](2.åƒåœ¾å›æ”¶ç®—æ³•)
[3.åˆ†ä»£åƒåœ¾å›æ”¶](3.åˆ†ä»£åƒåœ¾å›æ”¶)
[4.åƒåœ¾å›æ”¶å™¨](4.åƒåœ¾å›æ”¶å™¨)
[5.åƒåœ¾å›æ”¶è°ƒä¼˜](5.åƒåœ¾å›æ”¶è°ƒä¼˜)



#### 1.å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶

##### 1.1 å¼•ç”¨è®¡æ•°æ³•

æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸ªè®¡æ•°å™¨ï¼Œå¦‚æœè¢«å¼•ç”¨äº†å°±+1ï¼Œå°‘ä¸€ä¸ªå¼•ç”¨å°±å‡1



ä¼šæœ‰å¾ªç¯å¼•ç”¨çš„é—®é¢˜

![image-20211023161520942](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023161521.png)





##### 1.2 å¯è¾¾æ€§åˆ†æ

- Java è™šæ‹Ÿæœºä¸­çš„åƒåœ¾å›æ”¶å™¨é‡‡ç”¨å¯è¾¾æ€§åˆ†ææ¥æ¢ç´¢æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡
- æ‰«æå †ä¸­çš„å¯¹è±¡ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿæ²¿ç€ GC Rootå¯¹è±¡ ä¸ºèµ·ç‚¹çš„å¼•ç”¨é“¾æ‰¾åˆ°è¯¥å¯¹è±¡ï¼Œæ‰¾ä¸åˆ°ï¼Œè¡¨ç¤ºå¯ä»¥å›æ”¶
- å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸º GC Root ?



> GC Rootçš„å¯¹è±¡

https://www.bilibili.com/video/BV1yE411Z7AP?p=51&spm_id_from=pageDriver è¿™ä¸ªè§†é¢‘å°†GC rootçš„å¯¹è±¡çš„

```bash
jmap - dump:format=b,live,file=1.bin è¿›ç¨‹id (å¯ä»¥ä½¿ç”¨jpså‘½ä»¤æŸ¥è¯¢)

#dump è¡¨ç¤ºå­˜æ”¾åˆ°æ–‡ä»¶é‡Œ
```

![image-20211023162408779](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023162408.png)





> çº¿ç¨‹ä¹Ÿæ˜¯gc root

çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿæœºæ ˆï¼Œæ‰€ä»¥æ ˆå¸§å’Œ**å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡(å…³æ³¨ç‚¹äº‹å¯¹è±¡ï¼Œä¸æ˜¯å¼•ç”¨)**éƒ½æ˜¯ï¼Œæ–¹æ³•å‚æ•°å¼•ç”¨çš„å¯¹è±¡ä¹Ÿæ˜¯

![image-20211023162550746](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023162550.png)

##### 1.3  å››ç§å¼•ç”¨

1. å¼ºå¼•ç”¨
- åªæœ‰æ‰€æœ‰ GC Roots å¯¹è±¡éƒ½ä¸é€šè¿‡ã€å¼ºå¼•ç”¨ã€‘å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ‰èƒ½è¢«åƒåœ¾å›æ”¶
2. è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰ **(å†…å­˜ä¸è¶³æ—¶ï¼Œåªè¦æ²¡æœ‰gc rootçš„å¼ºå¼•ç”¨äº†)**
- ä»…æœ‰è½¯å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶åï¼Œ**å†…å­˜ä»ä¸è¶³**æ—¶ä¼šå†æ¬¡å‡ºå‘åƒåœ¾å›æ”¶ï¼Œå›æ”¶è½¯å¼•ç”¨å¯¹è±¡
- **å¯ä»¥é…åˆ**å¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾è½¯å¼•ç”¨è‡ªèº«
3. å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰  **ï¼ˆåªè¦æ²¡æœ‰gc rootçš„å¼ºå¼•ç”¨äº†ï¼‰**
- ä»…æœ‰å¼±å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œ**æ— è®ºå†…å­˜æ˜¯å¦å……è¶³**ï¼Œ**éƒ½ä¼š**å›æ”¶å¼±å¼•ç”¨å¯¹è±¡
- **å¯ä»¥é…åˆ**å¼•ç”¨é˜Ÿåˆ—æ¥é‡Šæ”¾å¼±å¼•ç”¨è‡ªèº«
4. è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰
- **å¿…é¡»é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨**ï¼Œä¸»è¦é…åˆ ByteBuffer ä½¿ç”¨ï¼Œè¢«å¼•ç”¨å¯¹è±¡å›æ”¶æ—¶ï¼Œä¼šå°†è™šå¼•ç”¨å…¥é˜Ÿï¼Œç”± Reference Handler çº¿ç¨‹è°ƒç”¨è™šå¼•ç”¨ç›¸å…³æ–¹æ³•é‡Šæ”¾ç›´æ¥å†…å­˜
5. ç»ˆç»“å™¨å¼•ç”¨ï¼ˆFinalReferenceï¼‰
- æ— éœ€æ‰‹åŠ¨ç¼–ç ï¼Œä½†å…¶å†…éƒ¨é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œ**ç»ˆç»“å™¨å¼•ç”¨å…¥é˜Ÿ**ï¼ˆ**è¢«å¼•ç”¨å¯¹è±¡æš‚æ—¶æ²¡æœ‰è¢«å›æ”¶**ï¼‰ï¼Œå†ç”± Finalizer çº¿ç¨‹ (**ä¼˜å…ˆçº§ä½**)é€šè¿‡ç»ˆç»“å™¨å¼•ç”¨æ‰¾åˆ°è¢«å¼•ç”¨å¯¹è±¡å¹¶è°ƒç”¨å®ƒçš„ finalizeæ–¹æ³•ï¼Œ**ç¬¬äºŒæ¬¡ GC æ—¶æ‰èƒ½å›æ”¶è¢«å¼•ç”¨å¯¹è±¡**ã€‚
- ç¬¬ä¸€æ¬¡gcåªèƒ½è®©ç»ˆç»“æœŸå»å¼•ç”¨é˜Ÿåˆ—ï¼Œæ‰§è¡Œfinalizeæ–¹æ³•ï¼Œè€Œä¸”finalizerçº¿ç¨‹ä¼˜å…ˆçº§ä½ï¼Œå¯èƒ½è¦ç­‰ä¸€æ®µæ—¶é—´æ‰èƒ½æ‰§è¡Œè¿™ä¸ªfinalizeæ–¹æ³•ã€‚ç¬¬äºŒæ¬¡gcæ‰å›æ”¶è¿™ä¸ªå¯¹è±¡



å®çº¿çš„æ˜¯å¼ºå¼•ç”¨

![image-20211023163031116](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023163031.png)



> è½¯å¼•ç”¨-ä¾‹å­

![image-20211023164343047](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023164343.png)

![image-20211023164834251](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023164834.png)

listå¼ºå¼•ç”¨softReference ï¼Œ softReference è½¯å¼•ç”¨byte[] æ•°ç»„ã€‚å½“å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œè¿™äº›byte[] æ•°ç»„æœ‰çš„ä¼šè¢«å›æ”¶ã€‚å°±ä¸å›é€ æˆå†…å­˜æº¢å‡ºäº†



*æ¸…ç†è½¯å¼•ç”¨*ï¼š å¼•ç”¨é˜Ÿåˆ—

```java
ReferenceQueue<byte[]> queue = new ReferenceQueue();
// å…³è”å¼•ç”¨é˜Ÿåˆ— å½“è½¯å¼•ç”¨å…³è”çš„byte[]æ•°ç»„è¢«å›æ”¶æ—¶ï¼Œè½¯å¼•ç”¨å°±åŠ å…¥åˆ°queueä¸­å»
softReference<byte[]> ref = new softReference(new byte[4MB],queue);
```

ç§»é™¤æ— ç”¨çš„è½¯å¼•ç”¨ä»£ç å¦‚ä¸‹ï¼š queue.poll()å°±æ˜¯å¼¹å‡ºè½¯å¼•ç”¨é˜Ÿåˆ—é‡Œçš„è½¯å¼•ç”¨ï¼Œç„¶ååˆ æ‰å®ƒã€‚

![image-20211023205704138](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023205711.png)

> å¼±å¼•ç”¨å®ä¾‹

![image-20211023205932645](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023205932.png)



#### 2.åƒåœ¾å›æ”¶ç®—æ³•

##### 2.1 æ ‡è®°æ¸…é™¤ç®—æ³•

![image-20211023210403304](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023210403.png)



ç¬¬ä¸€æ­¥æ ‡è®°ï¼Œæ ‡è®°GC root ä¸å¯è¾¾çš„å¯¹è±¡(å›¾ä¸­ç°è‰²çš„éƒ¨åˆ†)ï¼Œç¬¬äºŒæ­¥æ¸…é™¤ç¬¬ä¸€æ­¥æ ‡è®°çš„å¯¹è±¡ã€‚

è¿™é‡Œçš„æ¸…é™¤å¹¶ä¸æ˜¯åˆ é™¤ï¼Œè€Œæ˜¯è®°å½•èµ·æ­¢ä½ç½®æ”¾è¿›ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œç„¶åä¸‹æ¬¡åˆ†é…å†…å­˜å°±åˆ°ç©ºé—²åˆ—è¡¨ä¸­çœ‹æœ‰æ²¡æœ‰åˆé€‚çš„å¤§å°ã€‚



ä¼˜ç¼ºç‚¹ï¼š

- åªç”¨æ ‡è®°ï¼Œé€Ÿåº¦å¾ˆå¿«
- å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡

##### 2.2 æ ‡è®°æ•´ç†

![image-20211023211001274](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023211001.png)



éœ€è¦æ‹·è´ç§»åŠ¨å†…å­˜å¯¹è±¡ï¼Œå°±ä¼šå¯¼è‡´åœ°å€æ”¹å˜ï¼Œé‚£ä¹ˆå¼•ç”¨çš„æŒ‡å‘ä¹Ÿéœ€è¦è·Ÿç€ä¿®æ”¹

ä¼˜ç¼ºç‚¹ï¼š

- æ²¡æœ‰å†…å­˜ç¢ç‰‡
- é€Ÿåº¦æ…¢

##### 2.3 å¤åˆ¶ç®—æ³•

![image-20211023211243786](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211023211243.png)

å…ˆæ ‡è®°ï¼Œç„¶åæŠŠæœ‰è®°å½•çš„ç›´æ¥å¤åˆ¶åˆ°toåŒºï¼Œç„¶åæŠŠfromçš„éƒ½åˆ æ‰



- æ²¡æœ‰å†…å­˜ç¢ç‰‡
- å ç”¨åŒå€çš„å†…å­˜ç©ºé—´



##### 2.3 åˆ†ä»£å›æ”¶

å †å†…å­˜åˆ†ä¸ºå¥½å‡ å—

![image-20211024095553454](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211024095600.png)



- å¯¹è±¡é¦–å…ˆåˆ†é…åœ¨ä¼Šç”¸å›­åŒºåŸŸ
- **æ–°ç”Ÿä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œè§¦å‘ minor gc**ï¼Œä¼Šç”¸å›­å’Œ from å­˜æ´»çš„å¯¹è±¡ä½¿ç”¨ copy å¤åˆ¶åˆ° to ä¸­ï¼Œå­˜æ´»çš„ å¯¹è±¡å¹´é¾„åŠ  1å¹¶ä¸”äº¤æ¢ from to  ï¼ˆæŒ‡å‘è¿™ä¸¤ä¸ªåŒºåŸŸçš„æŒ‡é’ˆæ”¹å˜ï¼Œç†è§£åº”è¯¥æ˜¯è¿™æ ·ï¼‰
  - ä¼Šç”¸å›­ä¸è¶³çš„æ—¶å€™å‘ç”Ÿç¬¬ä¸€æ¬¡åƒåœ¾å›æ”¶
  - ç¬¬äºŒæ¬¡æ–°ç”Ÿä»£ç©ºé—´ä¸è¶³çš„æ—¶å€™ï¼Œä¼Šç”¸å›­å’Œfroméƒ½ä¼šå‘ç”Ÿåƒåœ¾å›æ”¶
- minor gc ä¼šå¼•å‘ stop the worldï¼Œæš‚åœå…¶å®ƒç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œ 
- **å½“å¯¹è±¡å¯¿å‘½è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä¼šæ™‹å‡è‡³è€å¹´ä»£ï¼Œæœ€å¤§å¯¿å‘½æ˜¯15ï¼ˆå¯¹è±¡å¤´é‡Œé¢å¹´é¾„å‚æ•°ç”¨4bitå­˜æ”¾ï¼‰** 
- å½“è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼Œä¼šå…ˆå°è¯•è§¦å‘ minor gc(å…ˆçœ‹æ–°ç”Ÿä»£å¤Ÿä¸å¤Ÿå­˜)ï¼Œå¦‚æœä¹‹åç©ºé—´ä»ä¸è¶³ï¼Œé‚£ä¹ˆ**è§¦å‘ full gc**ï¼ŒSTWçš„æ—¶ é—´æ›´é•¿

#### 3.ç›¸å…³JVMå‚æ•°

| å«ä¹‰               | å‚æ•°                                                         |
| ------------------ | ------------------------------------------------------------ |
| å †åˆå§‹å¤§å°         | -Xms                                                         |
| å †æœ€å¤§å¤§å°         | -Xmx æˆ– -XX:MaxHeapSize=size                                 |
| æ–°ç”Ÿä»£å¤§å°         | -Xmn æˆ– (-XX:NewSize=size + -XX:MaxNewSize=size )            |
| å¹¸å­˜åŒºæ¯”ä¾‹ï¼ˆåŠ¨æ€ï¼‰ | -XX:InitialSurvivorRatio=ratio å’Œ -XX:+UseAdaptiveSizePolicy (åŠ¨æ€çš„è°ƒæ•´è¾›å­˜å»çš„æ¯”ä¾‹) |
| å¹¸å­˜åŒºæ¯”ä¾‹         | XX:SurvivorRatio=ratio  (é»˜è®¤ä¸º8ï¼Œ8æ˜¯Edençš„å¤§å° ï¼Œ  8:1:1)   |
| æ™‹å‡é˜ˆå€¼           | -XX:MaxTenuringThreshold=threshold  ï¼ˆæ ¹æ®åƒåœ¾å›æ”¶å™¨ä¸åŒï¼Œå¹´é¾„é˜ˆå€¼ä¹Ÿä¸åŒï¼Œæœ‰çš„æ˜¯15ï¼‰ |
| æ™‹å‡è¯¦æƒ…           | XX:+PrintTenuringDistribution                                |
| GCè¯¦æƒ…             | -XX:+PrintGCDetails -verbose:gc  ï¼ˆå‘ç”Ÿåƒåœ¾å›æ”¶ï¼Œæ‰“å°ä»–çš„è¯¦æƒ…ï¼‰ |
| FullGC å‰ MinorGC  | -XX:+ScavengeBeforeFullGC ï¼ˆfull gcå‰å…ˆåšä¸€æ¬¡minorGCï¼‰       |



##### TestDemo

```java
  // jvmå‚æ•°ï¼š -Xms20M -Xmx20M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc
    public static void main(String[] args) {

    }
}

/**è¾“å‡º
Heap
 def new generation   total 9216K, used 2026K [0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000)
  eden space 8192K,  24% used [0x00000000fec00000, 0x00000000fedfa988, 0x00000000ff400000)
  from space 1024K,   0% used [0x00000000ff400000, 0x00000000ff400000, 0x00000000ff500000)
  to   space 1024K,   0% used [0x00000000ff500000, 0x00000000ff500000, 0x00000000ff600000)
 tenured generation   total 10240K, used 0K [0x00000000ff600000, 0x0000000100000000, 0x0000000100000000)
   the space 10240K,   0% used [0x00000000ff600000, 0x00000000ff600000, 0x00000000ff600200, 0x0000000100000000)
 Metaspace       used 3184K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 344K, capacity 388K, committed 512K, reserved 1048576K
*/
```



```java

static int _5M = 5 * 1024 *1024;
static int _7M = 7 * 1024 *1024;
static int _8M = 8 * 1024 *1024;
// jvmå‚æ•°ï¼š -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc
public static void main(String[] args) {
    ArrayList<byte[]> list = new ArrayList<>();
    list.add(new byte[_8M]);
}
```

å¯ä»¥æ¥æµ‹è¯•å„ä¸ªé˜¶æ®µåƒåœ¾å›æ”¶ä¹‹åï¼Œå„åŒºçš„å ç”¨å¤§å°ï¼Œ



### 3.åƒåœ¾å›æ”¶å™¨

ä¸‰ç±»åƒåœ¾å›æ”¶å™¨

1. ä¸²è¡Œ
- å•çº¿ç¨‹
- å †å†…å­˜è¾ƒå°ï¼Œé€‚åˆä¸ªäººç”µè„‘
2. ååé‡ä¼˜å…ˆ
- å¤šçº¿ç¨‹
- å †å†…å­˜è¾ƒå¤§ï¼Œå¤šæ ¸ cpu
- è®©å•ä½æ—¶é—´å†…ï¼ŒSTW çš„æ—¶é—´æœ€çŸ­ 0.2 0.2 = 0.4ï¼Œåƒåœ¾å›æ”¶æ—¶é—´å æ¯”æœ€ä½ï¼Œè¿™æ ·å°±ç§°ååé‡é«˜
3. å“åº”æ—¶é—´ä¼˜å…ˆ
- å¤šçº¿ç¨‹
- å †å†…å­˜è¾ƒå¤§ï¼Œå¤šæ ¸ cpu
- å°½å¯èƒ½è®©å•æ¬¡ STW çš„æ—¶é—´æœ€çŸ­ 0.1 0.1 0.1 0.1 0.1 = 0.5



#### 3.1 ä¸²è¡Œ

> -XX:+UseSerialGC=Serial(æ–°ç”Ÿä»£çš„) + SerialOld(è€å¹´ä»£çš„)

Serialï¼šæ ‡è®°å¤åˆ¶

SerialOld ï¼š æ ‡è®°æ•´ç†

![image-20211024121949710](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211024121949.png)



#### 3.2 ååé‡ä¼˜å…ˆ

**å¹¶è¡Œ**

```java
// å¹¶è¡Œçš„åƒåœ¾å›æ”¶å™¨ï¼Œ(jdk1.8 é»˜è®¤å¼€å¯) ï¼Œä¸‹é¢éšä¾¿å¼€å¯ä¸€ä¸ªï¼Œå°±ä¼šé€‰æ‹©ä¸¤ä¸ªç®—æ³•ä½¿ç”¨
-XX:+UseParallelGC æˆ–è€… -XX:+UseParallelOldGC(æ ‡è®°æ•´ç†ç®—æ³•) 

-XX:+UseAdaptiveSizePolicy   //è‡ªåŠ¨è°ƒæ•´æ–°ç”Ÿä»£çš„å¤§å°(edenå’Œfromçš„æ¯”ä¾‹)
 
    

-XX:GCTimeRatio=ratio   // è°ƒæ•´ååé‡ 1/(1+ratio)  -> ä¼šè‡ªåŠ¨è°ƒå¤§å †çš„å†…å­˜ï¼Œæ¥å‡å°‘åƒåœ¾å›æ”¶çš„æ¬¡æ•°ï¼Œå¢åŠ ååé‡
-XX:MaxGCPauseMillis=ms  //æœ€å¤§æš‚åœæ¯«ç§’æ•°ï¼Œæœ€å¤§æ˜¯200msã€‚ å’Œä¸Šé¢çš„ååé‡æ˜¯ç›¸å¯¹çš„

    
-XX:ParallelGCThreads=n //æ§åˆ¶åƒåœ¾å›æ”¶çš„çº¿ç¨‹æ•°    
```

ParallelOldGC(æ ‡è®°æ•´ç†ç®—æ³•)

![image-20211024122414826](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211024122414.png)



#### 3.3 å“åº”æ—¶é—´ä¼˜å…ˆ (CMS  éœ€è¦å¥½å¥½çœ‹åˆ«äººçš„åšå®¢)

å¹¶å‘å¤±è´¥çš„è¯ï¼ŒCMSä¼šé€€åŒ–ä¸ºSerialOldåƒåœ¾å›æ”¶å™¨(å› ä¸ºå†…å­˜ç¢ç‰‡å¤ªå¤šäº†ï¼Œå¹¶å‘ä¸èµ·æ¥)ï¼ŒSerialOldæ¸…ç†ä¸€æ¬¡ï¼Œå†å˜å›CMS

æ ‡è®°æ¸…é™¤

**å¹¶å‘**   å¯ä»¥ä¸ç”¨ stw

```java
-XX:+UseConcMarkSweepGC æˆ–è€… -XX:+UseParNewGC ~ SerialOld
-XX:parallelGCThreads=n(é»˜è®¤ä¸º4) ~ -XX:ConcGCThreads=threads
-XX:CMSInitiatingOccupancyFraction=percent  // å†…å­˜å æ¯”ï¼Œè®¾ç½®åˆ°å¤šå°‘æ¯”ä¾‹ï¼Œå¼€å§‹åƒåœ¾å›æ”¶ã€‚ ç»™ç”¨æˆ·çº¿ç¨‹é¢„ç•™ä¸€äº›ç©ºé—´
-XX:+CMSScavengeBeforeRemark
```

![image-20211025100444070](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025100444.png)



æœ€åè¿™ä¸ªå¹¶å‘æ¸…ç†çš„æ—¶å€™ï¼Œå› ä¸ºç”¨æˆ·çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œæ‰€ä»¥è¿˜ä¼šäº§ç”Ÿä¸€äº›åƒåœ¾ï¼Œå°±å«æµ®åŠ¨åƒåœ¾ï¼Œéœ€è¦ä¸‹æ¬¡åƒåœ¾å›æ”¶æ‰èƒ½æ¸…ç†ã€‚



#### 3.4 G1

![image-20211025101411555](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025101411.png)

> é€‚ç”¨åœºæ™¯

- åŒæ—¶æ³¨é‡ååé‡å’Œä½å»¶è¿Ÿï¼Œé»˜è®¤æš‚åœç›®æ ‡200ms
- **è¶…å¤§å †å†…å­˜**ï¼Œä¼šå°†å †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„Region
- æ•´ä½“ä¸Š **æ ‡è®°+æ•´ç†** ï¼Œä¸¤ä¸ªåŒºåŸŸä¹‹é—´æ˜¯å¤åˆ¶ç®—æ³•

> ç›¸å…³JVMå‚æ•°

-XX:+UseG1GC

-XX:G1HeapRegionsize=size

-XX:MaxGCPauseMillis=time



##### 1.G1å›æ”¶é˜¶æ®µ

![image-20211025101937243](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025101937.png)



> young Collection

![image-20211025102003511](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025102003.png)

å †å†…å­˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªåŒºåŸŸã€‚Eä»£è¡¨Eden

Edenæ»¡äº†ï¼Œå°±ä¼šå‘ç”Ÿyoung Collectionã€‚ä¼šstw ã€‚ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè¿›å…¥å¹¸å­˜åŒº

![image-20211025103626890](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025103626.png)

å¦‚æœå¹¸å­˜åŒºçš„ä¸€äº›å¯¹è±¡å¹´é¾„åˆ°äº†ï¼Œå°±ä¼šå»è€å¹´ä»£ã€‚å¦‚æœä¸æ»¡çš„å°±å»å¦å¤–ä¸€ä¸ªå¹¸å­˜åŒº ï¼ˆfrom toï¼‰

![image-20211025103705075](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025103705.png)



> Young Collection + CM

- åˆå§‹æ ‡è®°ï¼Œåœ¨æ–°ç”Ÿä»£GCæ—¶ï¼Œè¿›è¡ŒGC rootçš„æ ‡è®° (stw
- è€å¹´ä»£å ç”¨è¾¾åˆ°é˜ˆå€¼äº‹ï¼Œè¿›è¡Œå¹¶å‘æ ‡è®°(ä¸ä¼šstw)ï¼Œç”±ä¸‹é¢çš„jvmå‚æ•°å†³å®š
  - -XX:InitiatingHeapOccupancyPercent=percent  ï¼ˆé»˜è®¤45%ï¼‰  å¦‚ä¸‹å›¾Oçš„åŒºåŸŸå¤§äº45%ï¼Œå°±å¹¶å‘æ ‡è®°

![image-20211025104034302](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025104034.png)



> Mixed Collection

**å®é™…ä¸Šï¼ŒG1åªç”¨äº†å¤åˆ¶ç®—æ³•**

ä¼šå¯¹Eã€Sã€Oè¿›è¡Œå…¨é¢çš„åƒåœ¾å›æ”¶

- æœ€ç»ˆæ ‡è®° ä¼šSTW     (é¿å…å¹¶å‘æ ‡è®°é˜¶æ®µäº§ç”Ÿçš„åƒåœ¾)
- æ‹·è´å­˜æ´» ä¼šSTW (å¤åˆ¶ç®—æ³•)
- -XX:MaxGCPauseMillis=ms

![image-20211025104418349](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025104418.png)

MIXed æ¸…ç†çš„æ—¶å€™ï¼ŒEå’ŒSåŒºåŸŸä¼šä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå°†å¯¹è±¡æ”¾è¿›S (toåŒº)ï¼Œå¦‚æœæœ‰çš„å¯¹è±¡å¹´é¾„å¤Ÿäº†ï¼Œå°±å»SåŒºåŸŸã€‚ç„¶åOåŒºåŸŸä¹Ÿä¼šå›æ”¶ï¼Œæœ‰ä¸¤ç§æƒ…å†µã€‚

- ç¬¬ä¸€ç§å¦‚æœæš‚åœæ—¶é—´èƒ½å¤Ÿè¾¾åˆ°ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„OåŒºåŸŸå°±ä½¿ç”¨æ ‡è®°å¤åˆ¶ç®—æ³•ã€‚ 
- ç¬¬äºŒç§ï¼Œå¦‚æœå…¨éƒ¨ä½¿ç”¨æ ‡è®°å¤åˆ¶ç®—æ³•ï¼Œstwæ—¶é—´å¤ªé•¿ï¼Œè¶…è¿‡äº†è®¾ç½®çš„æš‚åœæ—¶é—´ï¼ŒG1ä¼šé¢„å…ˆçŸ¥é“å“ªäº›OåŒºé‡Œé¢çš„åƒåœ¾æ¯”è¾ƒå¤šï¼Œç„¶ååªå¯¹ä¸€éƒ¨åˆ†Så»è¿›è¡Œå›æ”¶ã€‚(å¦‚å›¾ä¸­ï¼Œæœ‰é»„è‰²çš„OåŒºåŸŸå¹¶æ²¡æœ‰å‘ç”Ÿå›æ”¶)

##### 2.FUll GC



ä¸²è¡Œæ”¶é›†æ‰ å«full gc ã€‚ å¹¶å‘ä¸‹æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œå¹¶ä¸æ˜¯full gcã€‚åªæœ‰åƒåœ¾äº§ç”Ÿçš„é€Ÿåº¦å¤§äºå›æ”¶çš„é€Ÿåº¦ï¼Œé€€åŒ–ä¸ºä¸²è¡Œï¼Œæ‰æœ‰full gc (æ—¥å¿—é‡Œé¢ä¼šå¸¦full gcçš„åå­—)

![image-20211025110842049](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025110842.png)

##### 3. young Collection è·¨ä»£å¼•ç”¨  (éœ€è¦æŸ¥ä¸€ä¸‹èµ„æ–™)



å¦‚æœoldåŒºçš„å¯¹è±¡ï¼Œå¼•ç”¨äº†EdenåŒºã€‚  G1ä¸­æŠŠOldåŒºåŸŸåˆ’åˆ†ä¸ºå¾ˆå¤šcardã€‚ä¸Šé¢è¿™ç§æƒ…å†µï¼Œå°±è¢«ç§°ä¸ºè„cardã€‚ 

æ–°ç”Ÿä»£é‡Œé¢ä¼šæœ‰ä¸€ä¸ª Remembered Set è®°å½•è¿™äº›è„cardã€‚ç„¶å æ ‡è®°çš„æ—¶å€™ç›´æ¥å»éå†è¿™ä¸ªSeté‡Œé¢çš„ä¸œè¥¿

![image-20211025111306225](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211025111306.png)



##### 4.remark ï¼ˆé‡æ ‡è®°ï¼‰ æœä¸€ä¸‹æ–‡ç« 

é»‘ç™½ç°  (ä¸‰è‰²æ ‡è®°- çœ‹åšå®¢å§)

![image-20211026092329612](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026092329.png)





##### 5ã€jdk8åšçš„ä¸€äº›ä¼˜åŒ–

> JDK 8u20 å­—ç¬¦ä¸²å»é‡

ä¼˜ç‚¹ï¼šèŠ‚çœå¤§é‡å†…å­˜
ç¼ºç‚¹ï¼šç•¥å¾®å¤šå ç”¨äº† cpu æ—¶é—´ï¼Œæ–°ç”Ÿä»£å›æ”¶æ—¶é—´ç•¥å¾®å¢åŠ 
`-XX:+UseStringDeduplication  é»˜è®¤æ˜¯å¼€å¯çš„`

```java
String s1 = new String("hello"); // char[]{'h','e','l','l','o'}
String s2 = new String("hello"); // char[]{'h','e','l','l','o'}
```



- å°†æ‰€æœ‰æ–°åˆ†é…çš„å­—ç¬¦ä¸²æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—
- å½“æ–°ç”Ÿä»£å›æ”¶æ—¶ï¼ŒG1å¹¶å‘æ£€æŸ¥æ˜¯å¦æœ‰å­—ç¬¦ä¸²é‡å¤
- å¦‚æœå®ƒä»¬å€¼ä¸€æ ·ï¼Œè®©å®ƒä»¬å¼•ç”¨åŒä¸€ä¸ª char[]
- æ³¨æ„ï¼Œä¸ String.intern() ä¸ä¸€æ ·
  - String.intern() å…³æ³¨çš„æ˜¯å­—ç¬¦ä¸²å¯¹è±¡
  - è€Œå­—ç¬¦ä¸²å»é‡å…³æ³¨çš„æ˜¯ char[]
  - åœ¨ JVM å†…éƒ¨ï¼Œä½¿ç”¨äº†ä¸åŒçš„å­—ç¬¦ä¸²è¡¨

ä¸Šé¢çš„s1å’Œs2ï¼Œåƒåœ¾å›æ”¶ä¹‹åï¼Œéƒ½æŒ‡å‘åŒä¸€ä¸ªchar[] ï¼Œå›æ”¶å…¶ä¸­çš„ä¸€ä¸ª



> JDK 8u40 å¹¶å‘æ ‡è®°ç±»å¸è½½

æ‰€æœ‰å¯¹è±¡éƒ½ç»è¿‡å¹¶å‘æ ‡è®°åï¼Œå°±èƒ½çŸ¥é“å“ªäº›ç±»ä¸å†è¢«ä½¿ç”¨ï¼Œå½“ä¸€ä¸ªç±»åŠ è½½å™¨çš„æ‰€æœ‰ç±»éƒ½ä¸å†ä½¿ç”¨ï¼Œåˆ™å¸è½½å®ƒæ‰€åŠ è½½çš„æ‰€æœ‰ç±»

`-XX:+ClassUnloadingWithConcurrentMark` é»˜è®¤å¯ç”¨



å¸è½½æ¡ä»¶ï¼š (ä¸€èˆ¬éƒ½æ˜¯è‡ªå®šä¹‰ç±»åŠ è½½å™¨)

- ç±»çš„å®ä¾‹éƒ½è¢«å›æ”¶æ‰
- ç±»åŠ è½½å™¨é‡Œæ‰€æœ‰çš„ç±»éƒ½ä¸åœ¨ä½¿ç”¨

> JDK 8u60 å›æ”¶å·¨å‹å¯¹è±¡

g1ä¸­æœ‰å·¨å‹åŒºã€‚

- ä¸€ä¸ªå¯¹è±¡å¤§äº region çš„ä¸€åŠæ—¶ï¼Œç§°ä¹‹ä¸ºå·¨å‹å¯¹è±¡
- G1 ä¸ä¼šå¯¹å·¨å‹å¯¹è±¡è¿›è¡Œæ‹·è´
- å›æ”¶æ—¶è¢«ä¼˜å…ˆè€ƒè™‘
- G1 ä¼šè·Ÿè¸ªè€å¹´ä»£æ‰€æœ‰ incoming å¼•ç”¨ï¼Œè¿™æ ·è€å¹´ä»£ incoming å¼•ç”¨ä¸º0 çš„å·¨å‹å¯¹è±¡å°±å¯ä»¥åœ¨æ–°ç”Ÿä»£åƒåœ¾å›æ”¶æ—¶å¤„ç†æ‰  ==ã€‹(**å¦‚æœæ²¡æœ‰äººåœ¨è€å¹´ä»£å¼•ç”¨è¿™ä¸ªå·¨å‹å¯¹è±¡ï¼Œå°±ä¼šåœ¨æ–°ç”Ÿä»£åƒåœ¾å›æ”¶çš„æ—¶å€™å¤„ç†æ‰ï¼Œè¿™æ˜¯ä¸ºäº†æ›´æ—©çš„å¤„ç†å·¨å‹å¯¹è±¡**)

![image-20211026093303298](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026093303.png)



##### 6ã€jdk9åšçš„å¢å¼º

>å¹¶å‘æ ‡è®°èµ·å§‹æ—¶é—´çš„è°ƒæ•´

- å¹¶å‘æ ‡è®°å¿…é¡»åœ¨å †ç©ºé—´å æ»¡å‰å®Œæˆï¼Œå¦åˆ™é€€åŒ–ä¸º FullGC(fullgcçš„stwæ—¶é—´é•¿)
- JDK 9 ä¹‹å‰éœ€è¦ä½¿ç”¨ -XX:InitiatingHeapOccupancyPercent(å †å ç”¨æ¯”ä¾‹ï¼Œè¾¾åˆ°å¤šå°‘å°±åƒåœ¾å›æ”¶)
- JDK 9 å¯ä»¥åŠ¨æ€è°ƒæ•´(ä¸€å¼€å§‹è®¾ç½®å¥½æ¯”ä¾‹ä¹‹åï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šæ”¶é›†æ•°æ®ï¼ŒåŠ¨æ€è°ƒæ•´æ¯”ä¾‹ï¼Œé¢„ç•™æ›´å¤§çš„å †ç©ºé—²ç©ºé—´)
  - -XX:InitiatingHeapOccupancyPercent ç”¨æ¥è®¾ç½®åˆå§‹å€¼
  - è¿›è¡Œæ•°æ®é‡‡æ ·å¹¶åŠ¨æ€è°ƒæ•´
  - æ€»ä¼šæ·»åŠ ä¸€ä¸ªå®‰å…¨çš„ç©ºæ¡£ç©ºé—´



### 4. JVMè°ƒä¼˜  (è·³è¿‡äº†)

```
// æŸ¥çœ‹è™šæ‹Ÿæœºè¿è¡Œå‚æ•°
"C:\Program Files\Java\jdk1.8.0_91\bin\javaâ€ -XX:+PrintFlagsFinal -version | findstr "GC"
```

é¢„å¤‡çŸ¥è¯†

- æŒæ¡ GC ç›¸å…³çš„ VM å‚æ•°ï¼Œä¼šåŸºæœ¬çš„ç©ºé—´è°ƒæ•´
- æŒæ¡ç›¸å…³å·¥å…·
- æ˜ç™½ä¸€ç‚¹ï¼šè°ƒä¼˜è·Ÿåº”ç”¨ã€ç¯å¢ƒæœ‰å…³ï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„æ³•åˆ™



### 5ã€ç±»åŠ è½½å’Œå­—èŠ‚ç æŠ€æœ¯







#### 1.ç±»æ–‡ä»¶çš„ç»“æ„



> æ ¹æ® JVM è§„èŒƒï¼Œç±»æ–‡ä»¶ç»“æ„å¦‚ä¸‹

![image-20211026100538365](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026100538.png)





> å®ä¾‹å±•ç¤º

![image-20211026101600982](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026101601.png)

![image-20211026101619965](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026101620.png)





##### 1.é­”æ•°

> é­”æ•° magic  - èº«ä»½æ ‡è¯†

![image-20211026100755311](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026100755.png)



##### 2.ç‰ˆæœ¬ä¿¡æ¯

> minor_version major_version  ç‰ˆæœ¬ä¿¡æ¯

![image-20211026100859062](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026100859.png)



##### 3 å¸¸é‡æ± 

8-9å­—èŠ‚è¡¨ç¤ºå¸¸é‡æ± é‡Œé¢æœ‰å¤šå°‘é¡¹

![image-20211026101023229](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026101023.png)

0000000 ca fe ba be 00 00 00 34 00 23 **0a 00 06 00** 15 09

ç¬¬#1é¡¹ 0a(10ï¼Œéœ€è¦æŸ¥è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼Œæ‰¾åˆ°valueä¸º10çš„) è¡¨ç¤ºä¸€ä¸ª Method ä¿¡æ¯ï¼Œ00 06 å’Œ 00 15ï¼ˆ21ï¼‰ è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #6 å’Œ #21 é¡¹æ¥è·å¾—è¿™ä¸ªæ–¹æ³•çš„ã€æ‰€å±ç±»ã€‘å’Œã€æ–¹æ³•åã€‘

![image-20211026101230472](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026101230.png)





![image-20211026101529426](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026101529.png)

**initè¡¨ç¤ºæ„é€ æ–¹æ³•**



ä¸Šé¢è¿™äº›ç¬¬å‡ é¡¹çš„å‰ä¸¤ä½ä»£è¡¨ å¸¸é‡ç±»å‹(å»è¡¨æ ¼é‡Œé¢æ‰¾)ï¼Œä¹‹åçš„è¯æ ¹æ®ç±»å‹ä¼šæœ‰ä¸åŒçš„æ„é€ 

ä¾‹å¦‚ï¼š

- Method ä¿¡æ¯ åé¢è·Ÿä¸¤ä¸ª4å­—èŠ‚ ä»£è¡¨ æ‰€å±ç±»å’Œæ‰€å±æ–¹æ³•åã€‚
- utf8ä¸²ï¼Œåé¢4å­—èŠ‚æ˜¯é•¿åº¦ï¼Œç„¶åè¿™ä¸ªé•¿åº¦çš„å­—èŠ‚å°±æ˜¯è¿™ä¸ªä¸²è¡¨ç¤ºçš„å­—ç¬¦ä¸²



##### 4 è®¿é—®æ ‡è¯† access_flag

æŸ¥è¡¨

![image-20211026102912302](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026102912.png)



![image-20211026102950655](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026102950.png)

21 = 20+1 å³public + super

##### 5. ç±»å’Œçˆ¶ç±» 

==this_class å’Œsuperâ€”â€”class==

![image-20211026103026099](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026103026.png)



05 å¯¹åº”çš„ this_class  06å¯¹åº”çš„super_class 



##### 6. æ¥å£æ•°é‡å’Œæ¥å£ä¿¡æ¯

 åä¸¤ä¸ªå­—èŠ‚0000 å¯¹åº”çš„æ˜¯æ¥å£æ•°é‡

å› ä¸ºä¸º0 ï¼Œæ‰€ä»¥æ²¡æœ‰æ¥å£çš„ä¿¡æ¯ã€‚ä¸ç„¶å’Œå¸¸é‡æ± æ‰¾å¯¹åº”é¡¹ä¸€æ ·ã€‚å†ä¹‹åä¸¤ä¸ªå­—èŠ‚0000å¯¹åº”æˆå‘˜å˜é‡çš„ä¿¡æ¯ï¼Œå› ä¸ºæ˜¯0ï¼Œæ‰€ä»¥åé¢çš„fields[fields_count]æ²¡æœ‰ã€‚



##### 7.æˆå‘˜å˜é‡æ•°é‡å’Œä¿¡æ¯

> æˆå‘˜å˜é‡ä¿¡æ¯

æˆå‘˜å˜é‡å¯¹ç…§è¡¨ï¼Œä¸ºäº†å‹ç¼©å­—èŠ‚ï¼ŒBä»£è¡¨byteã€‚ã€‚ã€‚ç­‰ç­‰

![image-20211026103436531](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026103436.png)







##### 8.æ–¹æ³•æ•°é‡å’Œä¿¡æ¯



> Methodä¿¡æ¯

ä¹‹åä¸¤ä¸ªå­—èŠ‚æ˜¯æ–¹æ³•æ•°é‡ï¼Œ0002 ï¼Œä¸¤ä¸ªæ–¹æ³•ï¼Œä¸»æ–¹æ³•ã€æ„é€ æ–¹æ³•



ç„¶åæˆ‘ä»¬å¼€å§‹çœ‹ä¸€ä¸‹æ–¹æ³•çš„ä¿¡æ¯  `<init>` æ„é€ æ–¹æ³•çš„ä¿¡æ¯

![image-20211026103850284](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026103850.png)

![image-20211026103914775](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026103914.png)

![image-20211026103928368](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026103928.png)



è¿™äº›éƒ½æ˜¯æ ¹æ®è§„åˆ™ï¼ŒæŸ¥è¡¨æ‰¾å¯¹åº”çš„ä¿¡æ¯ï¼ŒæŸ¥å¸¸é‡æ± è·å–ä¿¡æ¯ã€‚



##### 9 é™„åŠ å±æ€§

![image-20211026104025084](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026104025.png)



00 01 è¡¨ç¤ºé™„åŠ å±æ€§æ•°é‡
00 13 è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #19 é¡¹ï¼Œå³ã€SourceFileã€‘
00 00 00 02 è¡¨ç¤ºæ­¤å±æ€§çš„é•¿åº¦
00 14 è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ±  #20 é¡¹ï¼Œå³ã€HelloWorld.javaã€‘



#### 2.å­—èŠ‚ç æŠ€æœ¯

##### 2.1 javapå·¥å…·

å¯ä»¥åç¼–è¯‘å­—èŠ‚ç æ–‡ä»¶

`javap -v HelloWord.class`  -væ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

![image-20211026112912464](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211026112912.png)

##### 2.2 å›¾è§£

> javaä»£ç 

```java
package cn.itcast.jvm.t3.bytecode;
/**
* æ¼”ç¤º å­—èŠ‚ç æŒ‡ä»¤ å’Œ æ“ä½œæ•°æ ˆã€å¸¸é‡æ± çš„å…³ç³»
*/
public class Demo3_1 {
public static void main(String[] args) {
int a = 10;
int b = Short.MAX_VALUE + 1;
int c = a + b;
System.out.println(c);
}
}
```

> ç¼–è¯‘ä¹‹åçš„å­—èŠ‚ç æ–‡ä»¶

```java
F:\01-ä»£ç \01-java\leetcode_pratice\target\test-classes>javap -v test4.class
Classfile /F:/01-ä»£ç /01-java/leetcode_pratice/target/test-classes/test4.class
åæœˆ 27, 2021 10:54:31 ä¸Šåˆ java.util.Currency info
INFO: currency.properties entry for 1111 is ignored because of the invalid country code.
  Last modified 2021-10-27; size 577 bytes
  MD5 checksum c6df5324e97def4d852531df39723cf8
  Compiled from "test4.java"
public class test4
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #7.#25         // java/lang/Object."<init>":()V
   #2 = Class              #26            // java/lang/Short
   #3 = Integer            32768
   #4 = Fieldref           #27.#28        // java/lang/System.out:Ljava/io/PrintStream;
   #5 = Methodref          #29.#30        // java/io/PrintStream.println:(I)V
   #6 = Class              #31            // test4
   #7 = Class              #32            // java/lang/Object
   #8 = Utf8               <init>
   #9 = Utf8               ()V
  #10 = Utf8               Code
  #11 = Utf8               LineNumberTable
  #12 = Utf8               LocalVariableTable
  #13 = Utf8               this
  #14 = Utf8               Ltest4;
  #15 = Utf8               main
  #16 = Utf8               ([Ljava/lang/String;)V
  #17 = Utf8               args
  #18 = Utf8               [Ljava/lang/String;
  #19 = Utf8               a
  #20 = Utf8               I
  #21 = Utf8               b
  #22 = Utf8               c
  #23 = Utf8               SourceFile
  #24 = Utf8               test4.java
  #25 = NameAndType        #8:#9          // "<init>":()V
  #26 = Utf8               java/lang/Short
  #27 = Class              #33            // java/lang/System
  #28 = NameAndType        #34:#35        // out:Ljava/io/PrintStream;
  #29 = Class              #36            // java/io/PrintStream
  #30 = NameAndType        #37:#38        // println:(I)V
  #31 = Utf8               test4
  #32 = Utf8               java/lang/Object
  #33 = Utf8               java/lang/System
  #34 = Utf8               out
  #35 = Utf8               Ljava/io/PrintStream;
  #36 = Utf8               java/io/PrintStream
  #37 = Utf8               println
  #38 = Utf8               (I)V
{
  public test4();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 8: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Ltest4;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=4, args_size=1
         0: bipush        10
         2: istore_1
         3: ldc           #3                  // int 32768
         5: istore_2
         6: iload_1
         7: iload_2
         8: iadd
         9: istore_3
        10: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
        13: iload_3
        14: invokevirtual #5                  // Method java/io/PrintStream.println:(I)V
        17: return
      LineNumberTable:
        line 10: 0
        line 11: 3
        line 12: 6
        line 13: 10
        line 14: 17
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      18     0  args   [Ljava/lang/String;
            3      15     1     a   I
            6      12     2     b   I
           10       8     3     c   I
}
SourceFile: "test4.java"

```

ç±»åŠ è½½ï¼Œå°±æ˜¯ä¼šæŠŠè¿™ä¸ªå­—èŠ‚ç æ–‡ä»¶è¯»å…¥åˆ°å†…å­˜ã€‚

> å¸¸é‡æ± è½½å…¥è¿è¡Œæ—¶å¸¸é‡æ± 

![image-20211027105548374](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027105548.png)

åªé€‰å–äº†éƒ¨åˆ†ã€‚



> æ–¹æ³•å­—èŠ‚ç è½½å…¥æ–¹æ³•åŒº

mainçš„æ–¹æ³•

![image-20211027105648800](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027105648.png)

> mainçº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œåˆ†é…æ ˆå¸§å†…å­˜

![image-20211027105738424](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027105738.png)

![image-20211027105752190](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027105752.png)

å±€éƒ¨å˜é‡ 4å’Œæœ€å¤§æ“ä½œæ•°æ ˆçš„æ·±åº¦2



> æ‰§è¡Œå¼•æ“æ‰§è¡Œå­—èŠ‚ç  (ç¬”è®°ç›´æ¥å¤åˆ¶å§)

å°±æ˜¯è¯»å–æŒ‡ä»¤ï¼Œè¯»å…¥åˆ°æ ˆä¸­ï¼Œå­˜æ”¾åˆ°æ§½ä½sloté‡Œï¼Œç„¶åæ ¹æ®å‡½æ•°å¯¹æ ˆé‡Œçš„æ•°æ®è¿›è¡Œæ“ä½œã€‚ i++é‡Œé¢çš„iinc 1,1 è¡¨ç¤ºæ§½ä½1é‡Œçš„æ•°æ®ç›´æ¥+1ã€‚



ã€‚ã€‚ã€‚



##### 2.3 æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤



![image-20211027110749139](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027110749.png)

å‡ ç‚¹è¯´æ˜ï¼š
byteï¼Œshortï¼Œchar éƒ½ä¼šæŒ‰ int æ¯”è¾ƒï¼Œå› ä¸ºæ“ä½œæ•°æ ˆéƒ½æ˜¯ 4 å­—èŠ‚
goto ç”¨æ¥è¿›è¡Œè·³è½¬åˆ°æŒ‡å®šè¡Œå·çš„å­—èŠ‚ç 

![image-20211027110811301](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027110811.png) ![image-20211027110821662](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027110821.png)



##### 2.4 æ„é€ æ–¹æ³•

> <cinit>()v

![image-20211027111008327](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027111008.png) ![image-20211027111014851](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027111014.png)

ç¼–è¯‘å™¨ä¼šæŒ‰ä»ä¸Šè‡³ä¸‹çš„é¡ºåºï¼Œæ”¶é›†æ‰€æœ‰ static é™æ€ä»£ç å—å’Œé™æ€æˆå‘˜èµ‹å€¼çš„ä»£ç ï¼Œåˆå¹¶ä¸ºä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³• <cinit>()V



> <init>()v

![image-20211027111228662](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027111228.png) ![](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027111243.png)



ç¼–è¯‘å™¨ä¼šæŒ‰ä»ä¸Šè‡³ä¸‹çš„é¡ºåºï¼Œæ”¶é›†æ‰€æœ‰ {} ä»£ç å—å’Œæˆå‘˜å˜é‡èµ‹å€¼çš„ä»£ç ï¼Œå½¢æˆæ–°çš„æ„é€ æ–¹æ³•ï¼Œä½†**åŸå§‹æ„é€ æ–¹æ³•å†…çš„ä»£ç æ€»æ˜¯åœ¨æœ€å**



##### 2.5 æ–¹æ³•è°ƒç”¨

![image-20211027112225105](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027112225.png)  ![image-20211027112233414](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027112233.png)



- new æ˜¯åˆ›å»ºã€å¯¹è±¡ã€‘ï¼Œç»™å¯¹è±¡åˆ†é…å †å†…å­˜ï¼Œæ‰§è¡ŒæˆåŠŸä¼šå°†ã€å¯¹è±¡å¼•ç”¨ã€‘å‹å…¥æ“ä½œæ•°æ ˆ
- dup æ˜¯å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å†…å®¹ï¼Œæœ¬ä¾‹å³ä¸ºã€å¯¹è±¡å¼•ç”¨ã€‘ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä»½å¼•ç”¨å‘¢ï¼Œ**ä¸€ä¸ªæ˜¯è¦é…åˆ invokespecial è°ƒç”¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³• "<init>":()V ï¼ˆä¼šæ¶ˆè€—æ‰æ ˆé¡¶ä¸€ä¸ªå¼•ç”¨ï¼‰**ï¼Œå¦ä¸€ä¸ªè¦é…åˆ astore_1 èµ‹å€¼ç»™å±€éƒ¨å˜é‡
- æœ€ç»ˆæ–¹æ³•ï¼ˆfinalï¼‰ï¼Œç§æœ‰æ–¹æ³•ï¼ˆprivateï¼‰ï¼Œæ„é€ æ–¹æ³•éƒ½æ˜¯ç”± invokespecial æŒ‡ä»¤æ¥è°ƒç”¨ï¼Œå±äºé™æ€ç»‘å®šï¼Œ**é€Ÿåº¦æ¯”invokevirtual å¿«**ã€‚ä¸€ä¸‹å­å°±èƒ½æ‰¾åˆ°æ–¹æ³•
- æ™®é€šæˆå‘˜æ–¹æ³•æ˜¯ç”± invokevirtual è°ƒç”¨ï¼Œå±äºåŠ¨æ€ç»‘å®šï¼Œ**å³æ”¯æŒå¤šæ€**
- æˆå‘˜æ–¹æ³•ä¸é™æ€æ–¹æ³•è°ƒç”¨çš„å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œæ‰§è¡Œæ–¹æ³•å‰æ˜¯å¦éœ€è¦ã€å¯¹è±¡å¼•ç”¨ã€‘
- æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ d.test4(); æ˜¯é€šè¿‡ã€å¯¹è±¡å¼•ç”¨ã€‘è°ƒç”¨ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨invokestatic ä¹‹å‰æ‰§è¡Œäº† pop æŒ‡ä»¤ï¼ŒæŠŠã€å¯¹è±¡å¼•ç”¨ã€‘ä»æ“ä½œæ•°æ ˆå¼¹æ‰äº†ğŸ˜‚ ã€‚  **test4æ˜¯é™æ€æ–¹æ³•ï¼Œå®é™…ä¸Šåªéœ€è¦invokestaticå³å¯ï¼Œä¸éœ€è¦ç”¨å¯¹è±¡å¼•ç”¨ï¼Œæ‰€ä»¥åŠ ä¸Šçš„è¯ä¼šå¤šä¸¤æ¡æ²¡æœ‰ç”¨çš„æŒ‡ä»¤**
- è¿˜æœ‰ä¸€ä¸ªæ‰§è¡Œ invokespecial çš„æƒ…å†µæ˜¯é€šè¿‡ super è°ƒç”¨çˆ¶ç±»æ–¹æ³•



##### 2.6 å¤šæ€çš„åŸç†

vtableæ˜¯è™šæ–¹æ³•è¡¨ï¼Œé‡Œé¢æœ‰æ–¹æ³•çš„åœ°å€ã€‚ é“¾æ¥çš„æ—¶å€™ä½ ç”¨çš„å“ªä¸ªæ–¹æ³•å°±å·²ç»ç¡®å®šäº†ã€‚



å½“æ‰§è¡Œ invokevirtual æŒ‡ä»¤æ—¶ï¼Œ
1. å…ˆé€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨æ‰¾åˆ°å¯¹è±¡
2. åˆ†æå¯¹è±¡å¤´ï¼Œæ‰¾åˆ°å¯¹è±¡çš„å®é™… Class
3. Class ç»“æ„ä¸­æœ‰ vtableï¼Œ**å®ƒåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µå°±å·²ç»æ ¹æ®æ–¹æ³•çš„é‡å†™è§„åˆ™ç”Ÿæˆå¥½äº†** 
4. æŸ¥è¡¨å¾—åˆ°æ–¹æ³•çš„å…·ä½“åœ°å€
5. æ‰§è¡Œæ–¹æ³•çš„å­—èŠ‚ç 



##### 2.7 try catch







> finally

finally å°±æ˜¯finallyé‡Œé¢çš„ä»£ç éƒ½å¤åˆ¶ä¸€ä»½ï¼Œç„¶åæ”¾åœ¨tryé‡Œé¢å’Œcatché‡Œé¢ã€‚ catchæ•è·ä¸åˆ°çš„å¼‚å¸¸ï¼Œfinallyä¹Ÿå¤åˆ¶è¿‡å»ä¸€ä»½

![image-20211027163420394](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211027163420.png)

##### 2.8 synchronized

```java
public static void main(String[] args) {
    Object lock = new Object();
    synchronized (lock) {
    System.out.println("ok");
    }
}
```

![image-20211029153840291](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029153840.png)



æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°



#### 3.ç¼–è¯‘å™¨å¤„ç†

æ‰€è°“çš„ è¯­æ³•ç³–ï¼Œå…¶å®å°±æ˜¯æŒ‡ java ç¼–è¯‘å™¨æŠŠ *.java æºç ç¼–è¯‘ä¸º *.class å­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨ç”Ÿæˆ
å’Œè½¬æ¢çš„ä¸€äº›ä»£ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡è½»ç¨‹åºå‘˜çš„è´Ÿæ‹…ï¼Œç®—æ˜¯ java ç¼–è¯‘å™¨ç»™æˆ‘ä»¬çš„ä¸€ä¸ªé¢å¤–ç¦åˆ©ï¼ˆç»™ç³–åƒå˜›ï¼‰



æ³¨æ„ï¼Œä»¥ä¸‹ä»£ç çš„åˆ†æï¼Œå€ŸåŠ©äº† javap å·¥å…·ï¼Œidea çš„åç¼–è¯‘åŠŸèƒ½ï¼Œidea æ’ä»¶ jclasslib ç­‰å·¥å…·ã€‚å¦å¤–ï¼Œç¼–è¯‘å™¨è½¬æ¢çš„ç»“æœç›´æ¥å°±æ˜¯ class å­—èŠ‚ç ï¼Œåªæ˜¯ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œç»™å‡ºäº† å‡ ä¹ç­‰ä»· çš„ java æºç æ–¹å¼ï¼Œå¹¶ä¸æ˜¯ç¼–è¯‘å™¨è¿˜ä¼šè½¬æ¢å‡ºä¸­é—´çš„ java æºç ï¼Œåˆ‡è®°ã€‚

##### 3.1 é»˜è®¤æ„é€ å™¨(ç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬åŠ ä¸Š)

```java
public class Candy1 {
}

// ç¼–è¯‘ä¹‹å
public class Candy1 {
    // è¿™ä¸ªæ— å‚æ„é€ æ˜¯ç¼–è¯‘å™¨å¸®åŠ©æˆ‘ä»¬åŠ ä¸Šçš„
    public Candy1() {
    super(); // å³è°ƒç”¨çˆ¶ç±» Object çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå³è°ƒç”¨ java/lang/Object."
    <init>":()V
    }
}
```



##### 3.2 è‡ªåŠ¨æ‹†è£…ç®±

```java
public static void main(String[] args) {
    Integer x = 1;
    int y = x;
}


// ç¼–è¯‘ä¹‹å
public static void main(String[] args) {
    Integer x = Integer.valueOf(1); // è£…ç®±
    int y = x.intValue();  // æ‹†ç®±
}
```



##### 3.3 æ³›å‹é›†åˆå–å€¼

```java
public static void main(String[] args) {
    List<Integer> list = new ArrayList<>();
    list.add(10); // å®é™…è°ƒç”¨çš„æ˜¯ List.add(Object e)
    Integer x = list.get(0); // å®é™…è°ƒç”¨çš„æ˜¯ Object obj = List.get(int index);
}


ç¼–è¯‘ä¹‹åå®é™…ä¸Šæ˜¯è¿™æ ·çš„
// éœ€è¦å°† Object è½¬ä¸º Integer
Integer x = (Integer)list.get(0);
// éœ€è¦å°† Object è½¬ä¸º Integer, å¹¶æ‰§è¡Œæ‹†ç®±æ“ä½œ
int x = ((Integer)list.get(0)).intValue();
```





å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„add æ–¹æ³•çš„å‚æ•°å®é™…ä¸Šæ˜¯object, æ“¦é™¤äº†å­—èŠ‚ç ä¸Šçš„æ³›å‹ä¿¡æ¯ï¼ŒLocalVariableTypeTable ä¿ç•™äº†æ–¹æ³•å‚æ•°æ³›å‹çš„ä¿¡æ¯ï¼Œåé¢ä½¿ç”¨checkcastè¿›è¡Œæ£€æŸ¥

![image-20211029154552799](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029154552.png)



>LocalVariableTypeTable å±€éƒ¨å˜é‡ç±»å‹è¡¨

![image-20211029154856076](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029154856.png)



> ä½¿ç”¨åå°„è·å–è¿™äº›ä¿¡æ¯

```java
Method test = Candy3.class.getMethod("test", List.class, Map.class);
Type[] types = test.getGenericParameterTypes();
for (Type type : types) {
    if (type instanceof ParameterizedType) {
        ParameterizedType parameterizedType = (ParameterizedType) type;
        System.out.println("åŸå§‹ç±»å‹ - " + parameterizedType.getRawType());
        Type[] arguments = parameterizedType.getActualTypeArguments();
        for (int i = 0; i < arguments.length; i++) {
        	System.out.printf("æ³›å‹å‚æ•°[%d] - %s\n", i, arguments[i]);
        }
    }
}
```

![image-20211029155229071](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029155229.png)



##### 3.4 å¯å˜å‚æ•°

jdk5åŠ å…¥çš„æ–°ç‰¹æ€§

å¯å˜å‚æ•° String... args å…¶å®æ˜¯ä¸€ä¸ª String[] args ï¼Œä»ä»£ç ä¸­çš„èµ‹å€¼è¯­å¥ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚
åŒæ · java ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´å°†ä¸Šè¿°ä»£ç å˜æ¢

```java
public class Candy4 {
    // String... args  ä¼šè¢«ç¼–è¯‘æˆString[] args
	public static void foo(String... args) {
        String[] array = args; // ç›´æ¥èµ‹å€¼
        System.out.println(array);
    }
    public static void main(String[] args) {
    	foo("hello", "world");
    }
}
```



##### 3.5 foreachå¾ªç¯

```java
public static void main(String[] args) {
    int[] array = {1, 2, 3, 4, 5}; // æ•°ç»„èµ‹åˆå€¼çš„ç®€åŒ–å†™æ³•ä¹Ÿæ˜¯è¯­æ³•ç³–å“¦
    for (int e : array) {
    	System.out.println(e);
    }
}

// ç¼–è¯‘ä¹‹åï¼Œç›¸å½“äºä¸‹é¢çš„
int[] array = new int[]{1, 2, 3, 4, 5};

for(int i = 0; i < array.length; ++i) {
    int e = array[i];
    System.out.println(e);
}



```

```java
#é›†åˆçš„æƒ…å†µ
    
List<Integer> list = Arrays.asList(1,2,3,4,5);
for (Integer i : list) {
	System.out.println(i);
}

Iterator iter = list.iterator();
while(iter.hasNext()) {
    Integer e = (Integer)iter.next();
    System.out.println(e);
}
```

æ³¨æ„
foreach å¾ªç¯å†™æ³•ï¼Œèƒ½å¤Ÿé…åˆæ•°ç»„ï¼Œä»¥åŠæ‰€æœ‰å®ç°äº† Iterable æ¥å£çš„é›†åˆç±»ä¸€èµ·ä½¿ç”¨ï¼Œå…¶ä¸­
Iterable ç”¨æ¥è·å–é›†åˆçš„è¿­ä»£å™¨ï¼ˆ Iterator ï¼‰



##### 3.6 Switch 



ä» JDK 7 å¼€å§‹ï¼Œswitch å¯ä»¥ä½œç”¨äºå­—ç¬¦ä¸²å’Œæšä¸¾ç±»ï¼Œè¿™ä¸ªåŠŸèƒ½å…¶å®ä¹Ÿæ˜¯è¯­æ³•ç³–ï¼Œä¾‹å¦‚ï¼š

>switch é…åˆ String å’Œæšä¸¾ä½¿ç”¨æ—¶ï¼Œå˜é‡ä¸èƒ½ä¸ºnullï¼ŒåŸå› åˆ†æå®Œè¯­æ³•ç³–è½¬æ¢åçš„ä»£ç åº”å½“è‡ªç„¶æ¸…æ¥š



###### å­—ç¬¦ä¸²

![image-20211029160221053](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029160221.png) ![image-20211029160228703](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029160228.png)

å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œäº†ä¸¤é switchï¼Œç¬¬ä¸€éæ˜¯æ ¹æ®å­—ç¬¦ä¸²çš„ hashCode å’Œ equals å°†å­—ç¬¦ä¸²çš„è½¬æ¢ä¸ºç›¸åº”byte ç±»å‹ï¼Œç¬¬äºŒéæ‰æ˜¯åˆ©ç”¨ byte æ‰§è¡Œè¿›è¡Œæ¯”è¾ƒã€‚



> ä¸ºä»€ä¹ˆç¬¬ä¸€éæ—¶å¿…é¡»æ—¢æ¯”è¾ƒ hashCodeï¼Œåˆåˆ©ç”¨ equals æ¯”è¾ƒå‘¢ï¼Ÿ

hashCode æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå‡å°‘å¯èƒ½çš„æ¯”è¾ƒï¼›è€Œ equals æ˜¯ä¸ºäº†é˜²æ­¢ hashCode å†²çªï¼Œä¾‹å¦‚ BM å’Œ C. è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çš„hashCodeå€¼éƒ½æ˜¯2123 

###### æšä¸¾ç±»

ä¼šæŠŠæšä¸¾ç±»ç¼–ç¨‹æ•°ç»„ï¼Œç„¶åç»™æšä¸¾ç±»é‡Œé¢çš„å…ƒç´ èµ‹å€¼ï¼Œåé¢å†æ¯”è¾ƒæ•´æ•°å€¼

![image-20211029161252341](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029161252.png)





> æšä¸¾ç±»çš„å­—èŠ‚ç ç”Ÿæˆ

![image-20211029161406005](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029161406.png)



##### 3.7 try-with - resources

```java
try(èµ„æºå˜é‡ = åˆ›å»ºèµ„æºå¯¹è±¡){
} catch( ) {
}
```

å…¶ä¸­èµ„æºå¯¹è±¡éœ€è¦å®ç° AutoCloseable æ¥å£ï¼Œä¾‹å¦‚ InputStream ã€OutputStream ã€
Connection ã€Statement ã€ResultSet ç­‰æ¥å£éƒ½å®ç°äº† AutoCloseable ï¼Œä½¿ç”¨ try-withresources
å¯ä»¥ä¸ç”¨å†™ finally è¯­å¥å—ï¼Œç¼–è¯‘å™¨ä¼šå¸®åŠ©ç”Ÿæˆå…³é—­èµ„æºä»£ç ï¼Œä¾‹å¦‚



> ç¼–è¯‘åï¼Œä¼šè‡ªåŠ¨å¢åŠ finally ï¼Œé‡Œé¢æœ‰å…³é—­çš„ä»£ç 

![image-20211029162250277](https://xy-picgo.oss-cn-shenzhen.aliyuncs.com/20211029162250.png)



ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸€ä¸ª addSuppressed(Throwable e) ï¼ˆæ·»åŠ è¢«å‹åˆ¶å¼‚å¸¸ï¼‰çš„æ–¹æ³•å‘¢ï¼Ÿæ˜¯ä¸ºäº†é˜²æ­¢å¼‚å¸¸ä¿¡æ¯çš„ä¸¢å¤±ï¼ˆæƒ³æƒ³ try-with-resources ç”Ÿæˆçš„ fianlly ä¸­å¦‚æœæŠ›å‡ºäº†å¼‚å¸¸ï¼‰



å¾€eé‡Œé¢æ·»åŠ äº†closeçš„å¼‚å¸¸ï¼Œå› ä¸ºfinallyçš„ä»£ç ä¼šå¾€tryå’Œcatché‡Œé¢copyä¸€ä»½ï¼Œé‚£ä¹ˆå°±ä¸ä¼šé—æ¼è¿™ä¸ªå¼‚å¸¸çš„ä¿¡æ¯

##### 3.10 (è¯­æ³•ç³–é‡å†™æ¡¥æ¥ **è¿™èŠ‚å’Œä¸‹ä¸€èŠ‚- æœªçœ‹è§†é¢‘**)

3.11



#### 4ã€ç±»åŠ è½½é˜¶æ®µ

